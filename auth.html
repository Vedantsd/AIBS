<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIBS | Farmer & Vendor Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="min-h-screen bg-green-50 flex items-center justify-center px-4">
  <div class="max-w-4xl w-full bg-white rounded-2xl shadow-xl overflow-hidden grid grid-cols-1 md:grid-cols-2">
    <!-- Left side info -->
    <div class="hidden md:flex flex-col justify-between bg-gradient-to-br from-green-500 to-green-700 text-white p-8">
      <div>
        <h1 class="text-3xl font-bold mb-2">AIBS</h1>
        <p class="text-green-100 text-sm">Agri Integrated Business System</p>
      </div>
      <div>
        <h2 class="text-xl font-semibold mb-2">Connect Farmers & Vendors</h2>
        <p class="text-sm text-green-100">
          Securely log in or sign up as a Farmer or Vendor. Your crop listings,
          store supplies and transactions are synced in real time.
        </p>
      </div>
      <p class="text-xs text-green-100/80">Admin login: use <span class="font-semibold">AdminLogin.html</span></p>
    </div>

    <!-- Right side auth forms -->
    <div class="p-6 sm:p-8 space-y-6">
      <!-- Role toggle -->
      <div>
        <p class="text-xs font-semibold text-green-700 mb-2 uppercase tracking-wide">Choose Role</p>
        <div class="inline-flex rounded-full border border-green-200 bg-green-50 overflow-hidden text-sm font-medium">
          <button id="roleFarmerBtn" class="px-4 py-2 bg-white text-green-700" data-role="Farmer">Farmer</button>
          <button id="roleVendorBtn" class="px-4 py-2 text-green-700/80" data-role="Vendor">Vendor</button>
        </div>
      </div>

      <!-- Tabs: Login / Sign up -->
      <div class="flex border-b border-gray-200 text-sm font-medium">
        <button id="tabLogin" class="px-4 py-2 -mb-px border-b-2 border-green-600 text-green-700">Login</button>
        <button id="tabSignup" class="px-4 py-2 text-gray-500">Sign up</button>
      </div>

      <!-- Login form -->
      <form id="loginForm" class="space-y-4 mt-2">
        <div>
          <label class="block text-xs font-semibold text-gray-600 mb-1">Email</label>
          <input id="loginEmail" type="email" required class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-green-500 focus:border-green-500" />
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-600 mb-1">Password</label>
          <input id="loginPassword" type="password" required class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-green-500 focus:border-green-500" />
        </div>
        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-2.5 rounded-lg shadow-sm">Login</button>
      </form>

      <!-- Signup form -->
      <form id="signupForm" class="space-y-4 mt-2 hidden">
        <div>
          <label class="block text-xs font-semibold text-gray-600 mb-1">Full name</label>
          <input id="signupName" type="text" required class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-green-500 focus:border-green-500" />
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-600 mb-1">Email</label>
          <input id="signupEmail" type="email" required class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-green-500 focus:border-green-500" />
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-600 mb-1">Password</label>
          <input id="signupPassword" type="password" minlength="6" required class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-green-500 focus:border-green-500" />
          <p class="text-[11px] text-gray-400 mt-1">Minimum 6 characters (Firebase requirement).</p>
        </div>
        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-2.5 rounded-lg shadow-sm">Create account</button>
      </form>

      <!-- Error / info -->
      <p id="authMessage" class="text-xs text-red-600 min-h-[1.5rem]"></p>
    </div>
  </div>

  <script src="firebase-config.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    if (!firebaseConfig || !firebaseConfig.projectId) {
      console.warn("Firebase config is empty. Please fill firebase-config.js before using auth.");
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const roleFarmerBtn = document.getElementById('roleFarmerBtn');
    const roleVendorBtn = document.getElementById('roleVendorBtn');
    const tabLogin = document.getElementById('tabLogin');
    const tabSignup = document.getElementById('tabSignup');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const authMessage = document.getElementById('authMessage');

    let selectedRole = 'Farmer';

    function setRole(role) {
      selectedRole = role;
      if (role === 'Farmer') {
        roleFarmerBtn.classList.add('bg-white');
        roleVendorBtn.classList.remove('bg-white');
      } else {
        roleVendorBtn.classList.add('bg-white');
        roleFarmerBtn.classList.remove('bg-white');
      }
    }

    roleFarmerBtn.addEventListener('click', () => setRole('Farmer'));
    roleVendorBtn.addEventListener('click', () => setRole('Vendor'));

    // Tabs toggle
    tabLogin.addEventListener('click', () => {
      tabLogin.classList.add('border-green-600', 'text-green-700');
      tabSignup.classList.remove('border-green-600', 'text-green-700');
      tabSignup.classList.add('text-gray-500');
      loginForm.classList.remove('hidden');
      signupForm.classList.add('hidden');
      authMessage.textContent = '';
    });

    tabSignup.addEventListener('click', () => {
      tabSignup.classList.add('border-green-600', 'text-green-700');
      tabLogin.classList.remove('border-green-600', 'text-green-700');
      tabLogin.classList.add('text-gray-500');
      signupForm.classList.remove('hidden');
      loginForm.classList.add('hidden');
      authMessage.textContent = '';
    });

    function redirectByRole(role) {
      if (role === 'Farmer') {
        window.location.href = 'FarmerDashboard.html';
      } else {
        window.location.href = 'VendorDashboard.html';
      }
    }

    // Sign up
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      authMessage.textContent = '';
      const name = document.getElementById('signupName').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const uid = cred.user.uid;
        const userRef = doc(db, 'aibs_users', uid);
        await setDoc(userRef, {
          name,
          email,
          type: selectedRole,
          status: 'active',
          createdAt: serverTimestamp(),
          lastLogin: serverTimestamp()
        });
        redirectByRole(selectedRole);
      } catch (err) {
        console.error(err);
        authMessage.textContent = err.message || 'Sign up failed.';
      }
    });

    // Login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      authMessage.textContent = '';
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        const uid = cred.user.uid;
        const userRef = doc(db, 'aibs_users', uid);
        const snap = await getDoc(userRef);
        if (!snap.exists()) {
          authMessage.textContent = 'Profile record not found. Please contact admin.';
          await signOut(auth);
          return;
        }
        const data = snap.data();
        if (data.type !== selectedRole) {
          authMessage.textContent = `This account is registered as ${data.type}, not ${selectedRole}.`;
          await signOut(auth);
          return;
        }
        redirectByRole(selectedRole);
      } catch (err) {
        console.error(err);
        authMessage.textContent = err.message || 'Login failed.';
      }
    });
  </script>
</body>
</html>
